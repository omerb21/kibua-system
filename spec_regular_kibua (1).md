# אפיון + הנחיות ביצוע טכניות – מערכת קיבוע זכויות רגילה (שכירים)


## חלק 1: אפיון פונקציונלי מלא – מערכת קיבוע זכויות רגילה (שכירים)

### 🧭 מטרת המערכת
מערכת לניהול קיבוע זכויות לצורכי מס לפי טופס 161ד עבור שכירים אשר הגיעו לגיל זכאות. המערכת מאפשרת קלט נתונים מהלקוח, חישוב סכום הפטור ממס על קצבה בהתאם לחוק, הפחתות עקב מענקים או היוונים קודמים, ומפיקה מסמכים רלוונטיים לצרכים מיסויים.

---

### 📥 קלטים עיקריים
- פרטי לקוח: שם, ת"ז, מין, תאריך לידה
- תאריך פרישה, תאריך תחילת קצבה (לצורך חישוב גיל זכאות)
- תאריך קיבוע בפועל (`fixation_date`)
- מענקים פטורים: אחד או יותר, כולל תאריכים, סכום, מעסיק
- היוונים: אחד או יותר, כולל תאריך, סכום, קצבה ממנה הוון
- שריון לפיצויים עתידיים

---

### 🧮 זרימת חישוב (בקו ישר)
1. חישוב גיל זכאות לפי מין ותאריך לידה
2. בדיקת האם מדובר בקיבוע רטרואקטיבי
3. קביעת תקרת הפטור לפי שנת הקיבוע
4. הצמדת כל מענק עד תאריך הקיבוע
5. הפחתת כל מענק × 1.35 מתקרת הפטור
6. הפחתת היוונים בגובה סכום ההיוון המלא
7. הפחתת השריון
8. חישוב יתרת הפטור לזכות הלקוח

---

### 🗃 טבלאות נתונים

#### טבלה: `clients`
- `id`
- `first_name`
- `last_name`
- `id_number`
- `birth_date`
- `gender`
- `retirement_date`
- `eligibility_date` (נחושב אוטומטית)
- `fixation_date`
- `reserved_exemption`

#### טבלה: `grants`
- `id`
- `client_id`
- `employer_name`
- `start_date`
- `end_date`
- `amount`
- `indexed_amount`
- `is_indexed`

#### טבלה: `capitalizations`
- `id`
- `client_id`
- `capitalization_amount`
- `capitalization_date`
- `pension_amount`

---

### 🖥 מבנה המסכים (UI)

#### טופס לקוח
- פרטי בסיס + תאריך קיבוע

#### רשימת מענקים
- טבלה + כפתור “הוסף מענק”
- הצגת סכום מוצמד ופטור יחסי (אם רלוונטי)

#### רשימת היוונים
- טבלה + כפתור “הוסף היוון”
- מציין אם קיזוז מלא מהפטור בוצע

#### עמוד סיכום (summary)
- יתרת פטור
- סכום פטור מנוצל
- סכום הפטור שנותר
- תצוגת נספחים

---

### 📄 פלטים
- טופס 161ד מלא כולל:
  - נתוני לקוח
  - סכום תקרה לפי השנה
  - נספח מענקים: עם הצמדה + מקדם 1.35
  - נספח היוונים: סכום מלא
  - שורת פטור סופי

---
