# אפיון + הנחיות ביצוע טכניות – מערכת קיבוע זכויות רגילה (שכירים)


## חלק 1: אפיון פונקציונלי מלא – מערכת קיבוע זכויות רגילה (שכירים)

### 🧭 מטרת המערכת
מערכת לניהול קיבוע זכויות לצורכי מס לפי טופס 161ד עבור שכירים אשר הגיעו לגיל זכאות. המערכת מאפשרת קלט נתונים מהלקוח, חישוב סכום הפטור ממס על קצבה בהתאם לחוק, הפחתות עקב מענקים או היוונים קודמים, ומפיקה מסמכים רלוונטיים לצרכים מיסויים.

---

### 📥 קלטים עיקריים
- פרטי לקוח: שם, ת"ז, מין, תאריך לידה
- תאריך פרישה, תאריך תחילת קצבה (לצורך חישוב גיל זכאות)
- תאריך קיבוע בפועל (`fixation_date`)
- מענקים פטורים: אחד או יותר, כולל תאריכים, סכום, מעסיק
- היוונים: אחד או יותר, כולל תאריך, סכום, קצבה ממנה הוון
- שריון לפיצויים עתידיים

---

### 🧮 זרימת חישוב (בקו ישר)
1. חישוב גיל זכאות לפי מין ותאריך לידה
2. בדיקת האם מדובר בקיבוע רטרואקטיבי
3. קביעת תקרת הפטור לפי שנת הקיבוע
4. הצמדת כל מענק עד תאריך הקיבוע
5. הפחתת כל מענק × 1.35 מתקרת הפטור
6. הפחתת היוונים בגובה סכום ההיוון המלא
7. הפחתת השריון
8. חישוב יתרת הפטור לזכות הלקוח

---

### 🗃 טבלאות נתונים

#### טבלה: `clients`
- `id`
- `first_name`
- `last_name`
- `id_number`
- `birth_date`
- `gender`
- `retirement_date`
- `eligibility_date` (נחושב אוטומטית)
- `fixation_date`
- `reserved_exemption`

#### טבלה: `grants`
- `id`
- `client_id`
- `employer_name`
- `start_date`
- `end_date`
- `amount`
- `indexed_amount`
- `is_indexed`

#### טבלה: `capitalizations`
- `id`
- `client_id`
- `capitalization_amount`
- `capitalization_date`
- `pension_amount`

---

### 🖥 מבנה המסכים (UI)

#### טופס לקוח
- פרטי בסיס + תאריך קיבוע

#### רשימת מענקים
- טבלה + כפתור “הוסף מענק”
- הצגת סכום מוצמד ופטור יחסי (אם רלוונטי)

#### רשימת היוונים
- טבלה + כפתור “הוסף היוון”
- מציין אם קיזוז מלא מהפטור בוצע

#### עמוד סיכום (summary)
- יתרת פטור
- סכום פטור מנוצל
- סכום הפטור שנותר
- תצוגת נספחים

---

### 📄 פלטים
- טופס 161ד מלא כולל:
  - נתוני לקוח
  - סכום תקרה לפי השנה
  - נספח מענקים: עם הצמדה + מקדם 1.35
  - נספח היוונים: סכום מלא
  - שורת פטור סופי

---

---

## חלק 2: הנחיות ביצוע טכניות – מערכת קיבוע זכויות רגילה (שכירים)

### 🔧 קובץ: `app.py`

#### ✔️ שימושים:
- ניהול ה־routes להצגת לקוחות, עריכה, חישוב, ייצוא PDF.
- שדות `fixation_date` ו־`eligibility_date` מחושבים ומועברים לפלט.

#### 🛠️ הנחיות:
- ודא שכל route שנוגע בחישוב מבצע קריאה ל־`calculations.py`
- ודא ש־`fixation_date` מועבר לכל חישוב כ־`datetime` מלא

---

### 🔧 קובץ: `calculations.py`

#### ✔️ פונקציות נדרשות:
- `calculate_eligibility_date(birth_date, gender)`
- `get_exemption_limit(year)`
- `calculate_indexed_amount(original_amount, end_date, fixation_date)`
- `calculate_total_grants(grants)`
- `calculate_total_capitalizations(capitalizations)`
- `calculate_remaining_exemption(client, grants, capitalizations)`

#### דוגמת מימוש:
```python
def get_exemption_limit(year):
    limits = {
        2020: 798600, 2021: 790200, 2022: 797040, 2023: 803520, 2024: 806400
    }
    return limits.get(year, 806400)
```

---

### 🔧 קובץ: `cbs_adjust.py`

#### ✔️ מטרת הקובץ:
- שליפת ערך מוצמד מה־API של הלמ"ס

#### שינוי נדרש:
- הפוך את הפונקציה:
```python
def calculate_adjusted_amount(amount, end_work_date)
```
ל־:
```python
def calculate_adjusted_amount(amount, end_work_date, fixation_date)
```

#### בתוך הפונקציה:
```python
'toDate': datetime.strptime(fixation_date, "%Y-%m-%d").date()
```

---

### 🔧 קובץ: `generate_161d.py`

#### ✔️ אחראי להפקת טופס 161ד בפורמט PDF

#### הנחיות:
- יש למשוך את:
  - `exemption_limit`
  - רשימת מענקים מוצמדים
  - רשימת היוונים
  - סכום פטור שנותר
- עבור כל מענק: הצג תאריך, סכום נומינלי, מוצמד, פטור לאחר 1.35
- עבור כל היוון: הצג סכום מלא + תאריך
- הוסף סעיף שריון (אם קיים)

---

### 🔧 קובץ: `templates/summary.html`

#### ✔️ עמוד סיכום ללקוח

#### הנחיות:
- הצג:
  - תקרת הפטור לפי שנה
  - הפחתות מהמענקים
  - הפחתות מהיוונים
  - שריון עתידי
  - יתרת הפטור הסופית
- אפשר לחצן: [הפק טופס PDF]

---

### 📡 אינטגרציה עם API של הלמ"ס

#### כתובת:
```
https://api.cbs.gov.il/index/data/calculator/120010
```

#### שדות חובה בפנייה:
```json
{
  "value": 100000,
  "date": "2016-05-01",
  "toDate": "2021-01-01",
  "format": "json"
}
```

---

### 🔁 תרחיש בדיקה מלא

1. הזנת לקוח עם תאריך קיבוע 1.1.2021
2. הזנת מענק משנת 2015 בגובה 100,000 ₪
3. ווידוא שהמערכת שולחת בקשת API להצמדה ל־1.1.2021
4. ווידוא שה־indexed_amount × 1.35 נגרע מהפטור
5. הזנת היוון מ־2018 בסך 250,000 ₪
6. ווידוא קיזוז מלא מהפטור
7. ווידוא שהיתרה מוצגת נכונה ושהטופס מופק עם כל הנתונים

---

### ✅ סיכום

כל רכיב במערכת חייב לפעול לפי תאריך הקיבוע (`fixation_date`)  
אין להשתמש ב־`datetime.today()` לחישוב ערכים מוצמדים.  
הפקת הפלט חייבת לכלול את **כל הנתונים המגולמים בחישוב** — ולשמור עקביות בין החישוב לבין המסמך המופק.

